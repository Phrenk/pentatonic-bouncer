<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pentatonic Bouncer - Standalone</title>
    <style>
        body { margin: 0; background: #ffffff; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        canvas { border: 1px solid #eee; cursor: pointer; max-width: 90vw; max-height: 80vh; }
        #ui { position: absolute; top: 20px; text-align: center; pointer-events: none; }
        .label { font-weight: bold; color: #000; }
    </style>
</head>
<body>
    <div id="ui">
        <h1>Pentatonic Bouncer</h1>
        <p>Clicca sul pentagono per attivare audio e movimento</p>
        <div id="status">Rimbalzi: 0 | Nota: -</div>
    </div>
    <canvas id="bouncerCanvas"></canvas>

    <script>
        const canvas = document.getElementById('bouncerCanvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        
        let audioCtx = null;
        let isPlaying = false;
        let bounceCount = 0;

        // Configurazione
        const sides = 5;
        const radius = 250;
        const ball = { x: 0, y: 0, vx: 4, vy: 3, r: 8 };
        const notes = [261.63, 293.66, 329.63, 392.00, 440.00]; // Pentatonica C D E G A
        const labels = ['DO', 'RE', 'MI', 'SOL', 'LA'];
        
        let centerX, centerY;
        let vertices = [];

        function init() {
            canvas.width = 600;
            canvas.height = 600;
            centerX = canvas.width / 2;
            centerY = canvas.height / 2;
            ball.x = centerX;
            ball.y = centerY;
            
            for (let i = 0; i < sides; i++) {
                const angle = (i * 2 * Math.PI) / sides - Math.PI / 2;
                vertices.push({
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                });
            }
        }

        function playSynthNote(index) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(notes[index], audioCtx.currentTime);
            
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.8);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.8);
        }

        function checkWallCollision() {
            for (let i = 0; i < sides; i++) {
                const p1 = vertices[i];
                const p2 = vertices[(i + 1) % sides];

                // Distanza punto-segmento
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const length = Math.sqrt(dx*dx + dy*dy);
                const dot = (((ball.x - p1.x) * dx) + ((ball.y - p1.y) * dy)) / (length*length);
                const closestX = p1.x + Math.max(0, Math.min(1, dot)) * dx;
                const closestY = p1.y + Math.max(0, Math.min(1, dot)) * dy;
                
                const dist = Math.sqrt((ball.x - closestX)**2 + (ball.y - closestY)**2);

                if (dist < ball.r) {
                    // Riflessione semplice
                    const nx = (closestX - ball.x) / dist;
                    const ny = (closestY - ball.y) / dist;
                    const dotProd = ball.vx * nx + ball.vy * ny;
                    
                    ball.vx -= 2 * dotProd * nx;
                    ball.vy -= 2 * dotProd * ny;
                    
                    // Esci dalla parete per evitare doppi rimbalzi
                    ball.x += ball.vx;
                    ball.y += ball.vy;

                    bounceCount++;
                    statusDiv.innerText = `Rimbalzi: ${bounceCount} | Nota: ${labels[i]}`;
                    playSynthNote(i);
                }
            }
        }

        function draw() {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Disegna Pentagono
            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#000';
            ctx.moveTo(vertices[0].x, vertices[0].y);
            for (let i = 1; i < sides; i++) ctx.lineTo(vertices[i].x, vertices[i].y);
            ctx.closePath();
            ctx.stroke();

            // Disegna Palla
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
            ctx.fillStyle = '#000';
            ctx.fill();

            if (isPlaying) {
                ball.x += ball.vx;
                ball.y += ball.vy;
                checkWallCollision();
            }

            requestAnimationFrame(draw);
        }

        canvas.addEventListener('click', () => {
            isPlaying = !isPlaying;
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        });

        init();
        draw();
    </script>
</body>
</html>